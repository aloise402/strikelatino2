<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Strike Latino 2 - Tabla & Juegos</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <div class="container">
    <h1>‚öæ STRIKE LATINO 2 - Temporada 5</h1>
    <p class="subtitle">Tabla de posiciones, historial de juegos y postemporada</p>

    <!-- Barra de progreso -->
    <div id="progress-container">
      <div id="progress-bar">0%</div>
    </div>

    <div id="error" class="hidden"></div>
    <div id="last-updated" class="muted hidden"></div>

    <!-- Tabla de posiciones -->
    <section id="standings-section" class="hidden">
      <h2>üèÜ Tabla de Posiciones</h2>
      <div class="table-wrapper">
        <table id="standings-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Equipo</th>
              <th>Jugador</th>
              <th class="num">Prog</th>
              <th class="num">JJ</th>
              <th class="num">W</th>
              <th class="num">L</th>
              <th class="num">Por jugar</th>
              <th class="num">Pts</th>
              <th>Postemporada</th>
            </tr>
          </thead>
          <tbody id="standings-body"></tbody>
        </table>
      </div>
    </section>

    <!-- Historial acumulado -->
    <section id="games-history-section" class="hidden">
      <h2>üìã Historial de juegos</h2>
      <ul id="games-history-list" class="games-list"></ul>
    </section>

    <!-- Postemporada -->
    <section id="playoffs-section" class="hidden">
      <h2>üèÜ Postemporada</h2>
      <div class="bracket">
        <div class="round">
          <h3>Cuartos de Final</h3>
          <div class="match">
            <div class="pair"><span id="seed1"></span> vs <span id="seed8"></span></div>
            <ul id="qf1-games" class="games"></ul>
          </div>
          <div class="match">
            <div class="pair"><span id="seed2"></span> vs <span id="seed7"></span></div>
            <ul id="qf2-games" class="games"></ul>
          </div>
          <div class="match">
            <div class="pair"><span id="seed3"></span> vs <span id="seed6"></span></div>
            <ul id="qf3-games" class="games"></ul>
          </div>
          <div class="match">
            <div class="pair"><span id="seed4"></span> vs <span id="seed5"></span></div>
            <ul id="qf4-games" class="games"></ul>
          </div>
        </div>
        <div class="round">
          <h3>Semifinales</h3>
          <div class="match">
            <div class="pair"><span id="sf1-team1">Ganador QF1</span> vs <span id="sf1-team2">Ganador QF4</span></div>
            <ul id="sf1-games" class="games"></ul>
          </div>
          <div class="match">
            <div class="pair"><span id="sf2-team1">Ganador QF2</span> vs <span id="sf2-team2">Ganador QF3</span></div>
            <ul id="sf2-games" class="games"></ul>
          </div>
        </div>
        <div class="round">
          <h3>Final</h3>
          <div class="match">
            <div class="pair"><span id="final-team1">Ganador SF1</span> vs <span id="final-team2">Ganador SF2</span></div>
            <ul id="final-games" class="games"></ul>
          </div>
        </div>
      </div>
    </section>
  </div>

  <footer>
    <p>Liga Strike Latino 2 ¬© 2025</p>
  </footer>

  <script>
    const el = {
      error: document.getElementById('error'),
      updated: document.getElementById('last-updated'),
      standingsSection: document.getElementById('standings-section'),
      standingsBody: document.getElementById('standings-body'),
      gamesHistorySection: document.getElementById('games-history-section'),
      gamesHistoryList: document.getElementById('games-history-list')
    };
    const show = x => x.classList.remove('hidden');
    const hide = x => x.classList.add('hidden');

    function parseGameString(s){
      const norm = (s||'').replace(/\s+/g,' ').trim();
      const parts = norm.split(' - ');
      if (parts.length >= 4) {
        const [homePart, awayPart, datePart, timePart] = parts;
        const splitLast = (txt) => {
          const i = txt.lastIndexOf(' ');
          if (i === -1) return { name: txt, score: '' };
          return { name: txt.slice(0,i), score: txt.slice(i+1) };
        };
        const h = splitLast(homePart);
        const a = splitLast(awayPart);
        return {
          home_team: h.name,
          home_score: h.score,
          away_team: a.name,
          away_score: a.score,
          ended_at_local: `${datePart} - ${timePart}`
        };
      }
      return { raw: s };
    }

    async function loadData(){
      hide(el.error);
      try{
        const r = await fetch('/api/full', {cache:'no-store'});
        if(!r.ok){
          let msg = `HTTP ${r.status}`;
          try{ const j = await r.json(); if (j && j.error) msg = j.error; }catch(_){}
          throw new Error(msg);
        }
        const data = await r.json();

        if (data.last_updated) {
          el.updated.textContent = `√öltima actualizaci√≥n: ${data.last_updated}`;
          show(el.updated);
        }

        // Standings
        el.standingsBody.innerHTML = '';
        (data.standings || []).forEach((row, i) => {
          const tr = document.createElement('tr');
          const pos = i + 1;
          tr.classList.toggle("clasificado", pos <= 8);

          tr.innerHTML = `
            <td>${pos}</td>
            <td class="team">${row.team}</td>
            <td class="user">${row.user}</td>
            <td class="num">${row.scheduled}</td>
            <td class="num">${row.played}</td>
            <td class="num">${row.wins}</td>
            <td class="num">${row.losses}</td>
            <td class="num">${row.remaining}</td>
            <td class="num">${row.points}</td>
            <td>${pos <= 8 ? "üèÜ <span class='badge'>Clasificado</span>" : "‚Äì"}</td>
          `;
          el.standingsBody.appendChild(tr);
        });
        show(el.standingsSection);

        // Historial acumulado
        el.gamesHistoryList.innerHTML = '';
        const history = data.games_history || [];
        if (history.length === 0) {
          el.gamesHistoryList.innerHTML = `<li class="muted">No hay juegos registrados a√∫n.</li>`;
        } else {
          history.forEach((g, i) => {
            let obj = g;
            if (typeof g === 'string') obj = parseGameString(g);
            const li = document.createElement('li');
            if (obj.raw) {
              li.textContent = obj.raw;
            } else {
              li.innerHTML = `
                <div><strong>${obj.home_team}</strong> ${obj.home_score} - ${obj.away_score} <strong>${obj.away_team}</strong></div>
                <div class="pill">${obj.ended_at_local}</div>
              `;
            }
            el.gamesHistoryList.appendChild(li);
          });
        }
        show(el.gamesHistorySection);

        // Playoffs (de momento manual, con postseason.json)
        if (data.playoffs) renderPlayoffs(data.playoffs);

      }catch(e){
        el.error.textContent = 'No se pudieron cargar los datos: ' + e.message;
        show(el.error);
      }
    }

    function renderPlayoffs(playoffs) {
      const setText = (id, txt) => document.getElementById(id).textContent = txt;
      setText("seed1", playoffs.QF1.teams[0]);
      setText("seed8", playoffs.QF1.teams[1]);
      setText("seed2", playoffs.QF2.teams[0]);
      setText("seed7", playoffs.QF2.teams[1]);
      setText("seed3", playoffs.QF3.teams[0]);
      setText("seed6", playoffs.QF3.teams[1]);
      setText("seed4", playoffs.QF4.teams[0]);
      setText("seed5", playoffs.QF4.teams[1]);

      const fillGames = (games, ulId) => {
        const ul = document.getElementById(ulId);
        ul.innerHTML = "";
        games.forEach((g,i) => {
          const li = document.createElement("li");
          li.textContent = `Juego ${i+1}: ${g}`;
          ul.appendChild(li);
        });
      };

      fillGames(playoffs.QF1.games, "qf1-games");
      fillGames(playoffs.QF2.games, "qf2-games");
      fillGames(playoffs.QF3.games, "qf3-games");
      fillGames(playoffs.QF4.games, "qf4-games");

      show(document.getElementById("playoffs-section"));
    }

    loadData();

    // Barra progreso temporada
    function updateSeasonProgress() {
      const startDate = new Date("2025-08-31");
      const endDate = new Date("2025-09-15");
      const now = new Date();

      const total = endDate - startDate;
      const elapsed = now - startDate;
      let percent = Math.max(0, Math.min(100, (elapsed / total) * 100));

      const bar = document.getElementById("progress-bar");
      const daysLeft = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));

      if (daysLeft < 2) {
        bar.textContent = `${daysLeft} d√≠a${daysLeft === 1 ? '' : 's'} restantes`;
      } else {
        bar.textContent = percent.toFixed(0) + "%";
      }
      bar.style.width = percent.toFixed(1) + "%";
    }

    updateSeasonProgress();
    setInterval(updateSeasonProgress, 60000);
  </script>
</body>
</html>
